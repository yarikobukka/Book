<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Biblio Radar</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="list.css">
</head>
<body>
  <!-- ログイン・新規登録用画面-->

  <div id="loginScreen">
    <h2>Biblio Radarへようこそ!</h2>

    <input type="email" id="loginEmail" placeholder="メールアドレス" required>
    <input type="password" id="loginPassword" placeholder="パスワード" required>
      
    <button id="loginBtn">ログイン</button>
    <button id="signupBtn">新規登録</button>
    <button id="guestBtn">ログインせずに使う</button>

    <p id="loginMessage"></p>
  </div>

  <div id="mainContent" style="display:none;">
    <button id="logoutBtn">ログアウト</button>
    <button id="backToLoginBtn">ログイン</button>

    <h1>Book List</h1>

    <form id="bookForm">
      <input type="hidden" id="editId">
      <div class="form-input">
        <table class="form-table">
          <tr><td><input type="text" id="title" placeholder="タイトル" class="input"></td></tr>
          <tr><td><input type="text" id="yomigana" placeholder="よみがな" class="input"></td></tr>
          <tr><td><input type="text" id="author" placeholder="著者" class="input"></td></tr>
        </table>
        <button id="submitBtn" class="button" type="submit">登録</button>
      </div>
    </form>

    <div class="content">
      <div id="result"></div>
      <h2>登録済みの書籍</h2>
      <div class="search-wrapper">
        <div class="search-box-container">
          <input type="text" id="searchBox" placeholder="検索" class="input"/>
          <button class="search-mode">⋮</button>
          <div class="menu">
            <p>検索方法を選んでください</p>
            <button class="and">完全一致</button>
            <button class="or">部分一致</button>
          </div>
        </div>
      </div>
      <div class="selectOrder-wrapper">
        <span class="chevron-icon"></span>
        <select id="selectOrder">
          <option value="new" selected>新しい順</option>
          <option value="old">古い順</option>
          <option value="reading">タイトル順</option>
        </select>
      </div>
      <ul id="bookList"></ul>
      <p id="noResult" style="display:none;">該当する書籍が見つかりません</p>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const client = createClient(
      "https://urfhwurcnoexapukhcey.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZmh3dXJjbm9leGFwdWtoY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMDM5MzAsImV4cCI6MjA3NDc3OTkzMH0.bHVwIfrGVm_pbbSh1UByqgkE3Uq22a6IXcYnZmcJo-Y"
    );

    let currentSort = "new";

    let uiState = "login"; // "login" | "guest" | "auth"
    let currentUser = null;

    function getBooksTable() {
      return currentUser ? "books_private" : "books_public";
      // ログインユーザー=> privateテーブル
      // ゲスト=> publicテーブル
    }

    function updateUI() {
      const loginScreen = document.getElementById("loginScreen");
      const mainContent = document.getElementById("mainContent");
      const logoutBtn = document.getElementById("logoutBtn");
      const backToLoginBtn = document.getElementById("backToLoginBtn");

      if (!loginScreen || !mainContent || !logoutBtn || !backToLoginBtn) {
        console.error("UI要素が見つかりません");
        return;
      }

      loginScreen.style.display = "none";
      mainContent.style.display = "none";
      logoutBtn.style.display = "none";
      backToLoginBtn.style.display = "none";

      if (uiState === "login") {
        loginScreen.style.display = "block";
      }
      if (uiState === "guest") {
        mainContent.style.display = "block";
        backToLoginBtn.style.display = "block";
      }
      if (uiState === "auth") {
        mainContent.style.display = "block";
        logoutBtn.style.display = "block";
      }
    }

    // ふりがなをひらがなに固定する
    function normalizeTyping(v) {
      return v.normalize("NFKC");
    }

    const yomiganaInput = document.getElementById("yomigana");

    if (yomiganaInput) {
      yomiganaInput.addEventListener("input", () => {
        yomiganaInput.value = normalizeTyping(yomiganaInput.value);
      });
    }

    function normalizeForSave(v) {
      return v
        .normalize("NFKC")
        .replace(/[\u30a1-\u30f6]/g, c =>
          String.fromCharCode(c.charCodeAt(0) - 0x60)
        )
      .replace(/[^ぁ-んゔ0-9・ー＆\s]/g, "");
    }

    const saveButton = document.getElementById("submitBtn");

    // 一覧を読み込む
    async function loadBooks() {
      const tableName = getBooksTable();

      const { data, error } = await client
        .from(tableName)
        .select("*");

      if (error) {
        console.error("読み込み失敗:", error);
        return;
      }

      if (currentSort === "reading") {
        data.sort((a, b) => {
          const textA = a.yomigana || a.title || "";
          const textB = b.yomigana || b.title || "";
          return textA.localeCompare(textB, 'ja');
        });
      } else if (currentSort === "old") {
        data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else {
        data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }

      // リスト生成
      const list = document.getElementById("bookList");
      list.innerHTML = "";

      // 日付フォーマット
      function formatDate(created_at) {
        const now = new Date();
        const date = new Date(created_at);
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        const diffWeek = Math.floor(diffDay / 7);
        const diffMonth = Math.floor(diffDay / 30);
        const diffYear = Math.floor(diffDay / 365);
          
        if (diffDay === 0) {
          if (diffHour > 0) return `${diffHour}時間前`;
          if (diffMin > 0) return `${diffMin}分前`;
          return "たった今";
        } else if (diffDay === 1) return "昨日";
        else if (diffDay === 2)return "おととい";
        else if (diffDay >= 3 && diffDay <= 7) return `${diffDay}日前`;
        else if (diffWeek <= 4) {
          return `${diffWeek}週間前`;
        } else if (diffMonth <= 11) {
          return `${diffMonth}ヶ月前`;
        } else {
          return `${diffYear}年前`;
        }
      }

      const menuHtml = currentUser ? `
        <button class="menu-btn">⋮</button>
        <div class="menu">
          <button class="edit-btn">編集</button>
          <button class="delete-btn">削除</button>
        </div>
      ` : "";

      data.forEach(book => {
        const li = document.createElement("li");
        li.className = "card";
        li.dataset.yomigana = book.yomigana || "";

        li.innerHTML = `
          <div class="card-top">
            <div class="title">${book.title}</div>
            <div class="author">${book.author || ""}</div>
          </div>

          <div class="card-bottom">
            <div class="date">${formatDate(book.created_at)}</div>
            ${menuHtml}
          </div>
        `;

        // メニュー開閉
        if (currentUser) {
          const menuBtn = li.querySelector(".menu-btn");
          const menu = li.querySelector(".menu");

          menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();

            // 他のメニューを閉じる
            document.querySelectorAll(".menu.open").forEach(m => {
            m.classList.remove("open");
          });

          // すでに開いていたら閉じる
          if (menu.classList.contains("open")) {
            menu.classList.remove("open");
            document.body.removeChild(menu);
            li.appendChild(menu);
            return;
          }

          // メニューをbody直下に移動して表示
          document.body.appendChild(menu);
          const rect = menuBtn.getBoundingClientRect();
          menu.style.position = "fixed";
          menu.style.top = `${rect.bottom + 4}px`;
          menu.style.left = `${rect.right - 80}px`; // 横位置調整
          menu.style.zIndex = 9999;
          menu.classList.add("open");

          // 外側クリックで閉じる
          const closeMenu = (event) => {
            if (!menu.contains(event.target) && event.target !== menuBtn) {
              menu.classList.remove("open");
              document.body.removeChild(menu);
              li.appendChild(menu);
              document.removeEventListener("click", closeMenu);
            }
          };

          setTimeout(() => document.addEventListener("click", closeMenu), 0);
          })
        };

        // 編集ボタン
        li.querySelector(".edit-btn").onclick = (e) => {
          e.stopPropagation();
          editBook(book);
          menu.classList.remove("open");
          if (menu.parentNode === document.body) {
            document.body.removeChild(menu);
            li.appendChild(menu);
          }
        };

        // 削除ボタン
        li.querySelector(".delete-btn").onclick = (e) => {
          e.stopPropagation();
          deleteBook(book.id);
          menu.classList.remove("open");
        };

        list.appendChild(li);
      });
    }

    // 登録 or 更新
    document.getElementById("bookForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const yomiganaRaw = document.getElementById("yomigana").value;
      const yomigana = normalizeForSave(yomiganaRaw);
      const author = document.getElementById("author").value.trim();
      const editId = document.getElementById("editId").value;

      if (!title) return;

      // 重複チェック
      const tableName = getBooksTable();
      let savedSuccessfully = false;

      const { data: exist, error: existError } = await client
        .from(tableName)
        .select("*")
        .eq("title", title)
        .eq("author", author);
      
      if (existError) {
        alert("確認エラー: " + existError.message);
        return;
      }

      if (!editId && exist.length > 0) {
        alert("その本は既に登録済みです！");
        return;
      }

      let insertData = null;

      if (editId) {
        const { error } = await client
          .from(tableName)
          .update({ title, yomigana, author })
          .eq("id", editId);

        if (error) {
          alert("更新失敗: " + error.message);
          return;
        } else {
          alert("更新しました！");
          savedSuccessfully = true;
        }

      } else {
        insertData = { title, yomigana, author, user_id: currentUser.id };

        const { error } = await client
          .from(tableName)
          .insert([insertData]);

        if (error) {
          alert("登録失敗: " + error.message);
          return;
        } else {
          alert("登録しました！");
          savedSuccessfully = true;
        }
      }


      if (savedSuccessfully && title && author) {
        document.querySelector("#result").textContent = "推薦中...";
        const data = await fetchRecommendations(title, author);

        if (data && data.books) {
          const container = document.querySelector("#result");
          container.innerHTML = "";

          const heading = document.createElement("h2");
          heading.textContent = "おすすめの本";
          container.appendChild(heading);

          const table = document.createElement("table");
          table.className = "recommendTable";

          const tbody = document.createElement("tbody");
          Object.entries(data.books).forEach(([keyword, book]) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${keyword}</td>
              <td>${book.title}</td>
              <td>${book.author}</td>
            `;
            tbody.appendChild(tr);
          });
        
          table.appendChild(tbody);
          container.appendChild(table);

        } else {
          document.querySelector("#result").textContent = "関連書籍は見つかりませんでした。";
        }
      }

      // 後始末
      e.target.reset();
      document.getElementById("editId").value = "";
      document.getElementById("submitBtn").textContent = "登録";

      await loadBooks();
      updateUI();
    });

    // 検索機能

    function runSearch() {
      const word = document.getElementById("searchBox").value.toLowerCase().trim();
      const cards = document.querySelectorAll("#bookList .card");
      const noResult = document.getElementById("noResult");

      if (word === "") {
        cards.forEach(card => card.style.display = "");
        noResult.style.display = "none";
        return;
      }

      let hitCount = 0;
      const terms = word.split(/\s+/).filter(Boolean);

      cards.forEach(card => {
        const text =
          card.querySelector(".title").textContent.toLowerCase() + " " +
          card.querySelector(".author").textContent.toLowerCase() + " " +
          (card.dataset.yomigana?.toLowerCase() || "");

        let isMatch;

        if (searchMode === "and") {
          // AND検索（完全一致）
          isMatch = terms.every(t => text.includes(t));
        }else {
          // OR検索（部分一致）
          isMatch = terms.some(t => text.includes(t));
        }
    
        card.style.display = isMatch ? "" : "none";
        if (isMatch) hitCount++;
      });

      noResult.style.display = hitCount === 0 ? "block" : "none";
    }

    document.getElementById("searchBox").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        e.target.blur();
        runSearch();
      }
    });

    let searchMode = "or";

    const menuBtn = document.querySelector(".search-box-container .search-mode");
    const menuBox = document.querySelector(".search-box-container .menu");
    const btnAND = document.querySelector(".search-box-container .and");
    const btnOR = document.querySelector(".search-box-container .or");

    function updateSearchModeUI() {
      btnAND.classList.toggle("active", searchMode === "and");
      btnOR.classList.toggle("active", searchMode === "or");
    }

    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menuBox.classList.toggle("open");
    });

    btnAND.addEventListener("click", () => {
      searchMode = "and";
      updateSearchModeUI();
      menuBox.classList.remove("open");
      runSearch();
    });

    btnOR.addEventListener("click", () => {
      searchMode = "or";
      updateSearchModeUI();
      menuBox.classList.remove("open");
      runSearch();
    });

    document.addEventListener("click", (e) => {
      if (!menuBox.contains(e.target) && e.target !== menuBtn) {
        menuBox.classList.remove("open");
      }
    });

    updateSearchModeUI();

    // 編集
    function editBook(book) {
      document.getElementById("title").value = book.title;
      document.getElementById("yomigana").value = book.yomigana;
      document.getElementById("author").value = book.author;
      document.getElementById("editId").value = book.id;
      document.getElementById("submitBtn").textContent = "更新";
    }

    // 削除
    async function deleteBook(id) {
      if (!confirm("本当に削除しますか？")) return;
      const tableName = getBooksTable();
      const { error } = await client.from(tableName).delete().eq("id", id);
      if (error) alert("削除失敗: " + error.message);
      else alert("削除しました！");
      loadBooks();
    }

    document.getElementById("selectOrder").addEventListener("change", (e) => {
      currentSort = e.target.value;
      loadBooks();
    });

    // ログイン
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const message = document.getElementById("loginMessage");

      const { data, error } = await client.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        message.textContent = "ログイン失敗：" + error.message;
      } else {
        message.textContent = "ログイン成功！";
        uiState = "auth";
        currentUser = data.user;
        updateUI();
        loadBooks();
      }
    });

    // 新規登録
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const message = document.getElementById("loginMessage");

      const { data, error } = await client.auth.signUp({
        email,
        password
      });

      if (error) {
        message.textContent = "登録失敗：" + error.message;
      } else {
        message.textContent = "登録成功！確認メールを送信しました。";
      }
    });

    // ログイン状態の確認
    async function checkLogin() {
      const { data } = await client.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        console.log("ログイン中:", currentUser);
      } else {
        currentUser = null;
        console.log("未ログイン:");
      }
    };

    // ログイン成功時
    async function onLoginSuccess(user) {
      currentUser = user;
      uiState = "auth";
      updateUI();
      await loadBooks();
    }

    // ログインなし使用
    document.getElementById("guestBtn").addEventListener("click", async () => {
      currentUser = null;
      uiState = "guest";
      updateUI();
      await loadBooks();
    });

    // ログアウト
    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.addEventListener("click", async () => {
      const { error } = await client.auth.signOut();

      if (error) {
        console.error("ログアウト失敗", error);
        alert("ログアウトに失敗しました");
        return;
      }

      console.log("ログアウト成功");
      currentUser = null;
      uiState = "login";
      updateUI();
    });

    // ログイン画面に戻る
    document.getElementById("backToLoginBtn").addEventListener("click", () => {
      uiState = "login";
      updateUI();
    });

    // 初期表示
    document.addEventListener("DOMContentLoaded", async () => {
      const { data } = await client.auth.getSession();

      if (data.session) {
        currentUser = data.session.user;
        uiState = "auth";
      } else {
        currentUser = null;
        uiState = "login";
      }

      updateUI();
      if (uiState !== "login") {
        await loadBooks();
      }
    });

    // 推薦API呼び出し
    async function fetchRecommendations(title, author) {
      try {
        const response = await fetch("https://backend-5x35.onrender.com/api/books", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, author })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "APIエラー");
        }

        console.log("推薦結果:", data);
        return data;
      } catch (error) {
        console.error("通信エラー:", error);
        return null;
      }
    }
  </script>
</body>
</html>