<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Supabase 書籍登録テスト</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="list.css">
</head>
<body>
  <h1>Book List</h1>

  <form id="bookForm">
    <input type="hidden" id="editId">
    <div class="form-input">
      <table class="form-table">
        <tr><td><input type="text" id="title" placeholder="タイトル" class="input"></td></tr>
        <tr><td><input type="text" id="yomigana" placeholder="よみがな" class="input"></td></tr>
        <tr><td><input type="text" id="author" placeholder="著者" class="input"></td></tr>
      </table>
      <button id="submitBtn" class="button" type="submit">登録</button>
    </div>
  </form>

  <div class="content">
    <div id="result"></div>
    <h2>登録済みの書籍</h2>
    <div class="search-wrapper">
      <div class="search-box-container">
        <input type="text" id="searchBox" placeholder="検索" class="input"/>
        <button class="search-mode">⋮</button>
        <div class="menu">
          <p>検索方法を選んでください</p>
          <button class="and">完全一致</button>
          <button class="or">部分一致</button>
        </div>
      </div>
    </div>
    <div class="selectOrder-wrapper">
      <span class="chevron-icon"></span>
      <select id="selectOrder">
        <option value="new" selected>新しい順</option>
        <option value="old">古い順</option>
        <option value="reading">タイトル順</option>
      </select>
    </div>
    <ul id="bookList"></ul>
    <p id="noResult" style="display:none;">該当する書籍が見つかりません</p>
  </div>

  <script>
    const { createClient } = supabase;
    const client = createClient(
      "https://urfhwurcnoexapukhcey.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZmh3dXJjbm9leGFwdWtoY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMDM5MzAsImV4cCI6MjA3NDc3OTkzMH0.bHVwIfrGVm_pbbSh1UByqgkE3Uq22a6IXcYnZmcJo-Y"
    );

    let currentSort = "new";

    // ひらがな強制スクリプト
    const yomiganaInput = document.getElementById("yomigana");

    let isComposing = false;

    // IME入力が開始された時
    yomiganaInput.addEventListener("compositionstart", () => {
      isComposing = true;
    });

    // IME確定後
    yomiganaInput.addEventListener("compositionend", () => {
      isComposing = false;
      convertToHiragana();
    });

    // 入力中に常に監視
    yomiganaInput.addEventListener("input", () => {
      if (!isComposing) convertToHiragana();
    });

    function convertToHiragana() {
      let v = yomiganaInput.value;

      // カタカナ → ひらがな
      v = v.normalize("NFKC").replace(/[\u30a1-\u30f6]/g, (char) =>
        String.fromCharCode(char.charCodeAt(0) - 0x60)
      );

      // ひらがなと「ー」だけ許可
      v = v.replace(/[^ぁ-ん0-9・ー\s]/g, "");

      yomiganaInput.value = v;
    }

    // 一覧を読み込む
    async function loadBooks() {
      let { data, error } = await client.from("books").select("*");

      if (error) {
        console.error("読み込み失敗:", error);
        return;
      }

      if (currentSort === "reading") {
        data.sort((a, b) => {
          const textA = a.yomigana || a.title || "";
          const textB = b.yomigana || b.title || "";
          return textA.localeCompare(textB, 'ja');
        });
      } else if (currentSort === "old") {
        data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else {
        data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }

      // リスト生成
      const list = document.getElementById("bookList");
      list.innerHTML = "";

      // 日付フォーマット
      function formatDate(created_at) {
        const now = new Date();
        const date = new Date(created_at);
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        const diffWeek = Math.floor(diffDay / 7);
        const diffMonth = Math.floor(diffDay / 30);
        const diffYear = Math.floor(diffDay / 365);
          
        if (diffDay === 0) {
          if (diffHour > 0) return `${diffHour}時間前`;
          if (diffMin > 0) return `${diffMin}分前`;
          return "たった今";
        } else if (diffDay === 1) return "昨日";
        else if (diffDay === 2)return "おととい";
        else if (diffDay >= 3 && diffDay <= 7) return `${diffDay}日前`;
        else if (diffWeek <= 4) {
          return `${diffWeek}週間前`;
        } else if (diffMonth <= 11) {
          return `${diffMonth}ヶ月前`;
        } else {
          return `${diffYear}年前`;
        }
      }

      data.forEach(book => {
        const li = document.createElement("li");
        li.className = "card";
        li.dataset.yomigana = book.yomigana || "";
        li.innerHTML = `
          <div class="card-top">
            <div class="title">${book.title}</div>
            <div class="author">${book.author}</div>
          </div>
          <div class="card-bottom">
            <div class="date">${formatDate(book.created_at)}</div>
            <button class="menu-btn">⋮</button>
            <div class="menu">
              <button class="edit-btn">編集</button>
              <button class="delete-btn">削除</button>
            </div>
          </div>
        `;

        // メニュー開閉
        const menuBtn = li.querySelector(".menu-btn");
        const menu = li.querySelector(".menu");

        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();

          // 他のメニューを閉じる
          document.querySelectorAll(".menu.open").forEach(m => {
            m.classList.remove("open");
          });

          // すでに開いていたら閉じる
          if (menu.classList.contains("open")) {
            menu.classList.remove("open");
            document.body.removeChild(menu);
            li.appendChild(menu);
            return;
          }

          // メニューをbody直下に移動して表示
          document.body.appendChild(menu);
          const rect = menuBtn.getBoundingClientRect();
          menu.style.position = "fixed";
          menu.style.top = `${rect.bottom + 4}px`;
          menu.style.left = `${rect.right - 80}px`; // 横位置調整
          menu.style.zIndex = 9999;
          menu.classList.add("open");

          // 外側クリックで閉じる
          const closeMenu = (event) => {
            if (!menu.contains(event.target) && event.target !== menuBtn) {
              menu.classList.remove("open");
              document.body.removeChild(menu);
              li.appendChild(menu);
              document.removeEventListener("click", closeMenu);
            }
          };

          setTimeout(() => document.addEventListener("click", closeMenu), 0);
        });

        // 編集ボタン
        li.querySelector(".edit-btn").onclick = (e) => {
          e.stopPropagation();
          editBook(book);
          menu.classList.remove("open");
          if (menu.parentNode === document.body) {
            document.body.removeChild(menu);
            li.appendChild(menu);
          }
        };

        // 削除ボタン
        li.querySelector(".delete-btn").onclick = (e) => {
          e.stopPropagation();
          deleteBook(book.id);
          menu.classList.remove("open");
        };

        list.appendChild(li);
      });
    }

    // 登録 or 更新
    document.getElementById("bookForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const yomigana = document.getElementById("yomigana").value.trim();
      const author = document.getElementById("author").value.trim();
      const editId = document.getElementById("editId").value;

      if (!title) {
        return;
      }

      if (editId) {
        const { error } = await client
          .from("books")
          .update({ title, yomigana, author })
          .eq("id", editId);
        if (error) alert("更新失敗: " + error.message);
        else alert("更新しました！");
      } else {
        const { error } = await client
          .from("books")
          .insert([{ title, yomigana, author }]);
        if (error) alert("登録失敗: " + error.message);
        else alert("登録しました！");
      }

      e.target.reset();
      document.getElementById("editId").value = "";
      document.getElementById("submitBtn").textContent = "登録";
      loadBooks();
    });

    // 検索機能

    function runSearch() {
      const word = document.getElementById("searchBox").value.toLowerCase().trim();
      const cards = document.querySelectorAll("#bookList .card");
      const noResult = document.getElementById("noResult");

      if (word === "") {
        cards.forEach(card => card.style.display = "");
        noResult.style.display = "none";
        return;
      }

      let hitCount = 0;
      const terms = word.split(/\s+/).filter(Boolean);

      cards.forEach(card => {
        const text =
          card.querySelector(".title").textContent.toLowerCase() + " " +
          card.querySelector(".author").textContent.toLowerCase() + " " +
          (card.dataset.yomigana?.toLowerCase() || "");

        let isMatch;

        if (searchMode === "and") {
          // AND検索（完全一致）
          isMatch = terms.every(t => text.includes(t));
        }else {
          // OR検索（部分一致）
          isMatch = terms.some(t => text.includes(t));
        }
    
        card.style.display = isMatch ? "" : "none";
        if (isMatch) hitCount++;
      });

      noResult.style.display = hitCount === 0 ? "block" : "none";
    }

    document.getElementById("searchBox").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        e.target.blur();
        runSearch();
      }
    });

    let searchMode = "or";

    const menuBtn = document.querySelector(".search-box-container .search-mode");
    const menuBox = document.querySelector(".search-box-container .menu");
    const btnAND = document.querySelector(".search-box-container .and");
    const btnOR = document.querySelector(".search-box-container .or");

    function updateSearchModeUI() {
      btnAND.classList.toggle("active", searchMode === "and");
      btnOR.classList.toggle("active", searchMode === "or");
    }

    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menuBox.classList.toggle("open");
    });

    btnAND.addEventListener("click", () => {
      searchMode = "and";
      updateSearchModeUI();
      menuBox.classList.remove("open");
      runSearch();
    });

    btnOR.addEventListener("click", () => {
      searchMode = "or";
      updateSearchModeUI();
      menuBox.classList.remove("open");
      runSearch();
    });

    document.addEventListener("click", (e) => {
      if (!menuBox.contains(e.target) && e.target !== menuBtn) {
        menuBox.classList.remove("open");
      }
    });

    updateSearchModeUI();

    // 編集
    function editBook(book) {
      document.getElementById("title").value = book.title;
      document.getElementById("yomigana").value = book.yomigana;
      document.getElementById("author").value = book.author;
      document.getElementById("editId").value = book.id;
      document.getElementById("submitBtn").textContent = "更新";
    }

    // 削除
    async function deleteBook(id) {
      if (!confirm("本当に削除しますか？")) return;
      const { error } = await client.from("books").delete().eq("id", id);
      if (error) alert("削除失敗: " + error.message);
      else alert("削除しました！");
      loadBooks();
    }

    document.getElementById("selectOrder").addEventListener("change", (e) => {
      currentSort = e.target.value;
      loadBooks();
    });

    // 初回読み込み
    loadBooks();

    async function fetchRecommendations(title, author) {
      try {
        const response = await fetch("https://backend-5x35.onrender.com/api/books", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, author })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "APIエラー");
        }

        console.log("推薦結果:", data);
        return data;
      } catch (error) {
        console.error("通信エラー:", error);
        return null;
      }
    }

    // フォーム送信時に呼び出す
    document.querySelector("#submitBtn").addEventListener("click", async () => {
      const title = document.querySelector("#title").value.trim();
      const author = document.querySelector("#author").value.trim();

      if (!title || !author) {
        alert("タイトルと著者を入力してください");
        return;
      }

      document.querySelector("#result").textContent = "推薦中...";
      const data = await fetchRecommendations(title, author);

      if (data && data.books) {
        const container = document.querySelector("#result");
        container.innerHTML = "";

        // 見出し作成
        const heading = document.createElement("h2");
        heading.textContent = "あなたにおすすめの書籍";
        container.appendChild(heading);

        // テーブル作成
        const table = document.createElement("table");
        table.className = "recommendTable";

        //　テーブルの中身
        const tbody = document.createElement("tbody");
        Object.entries(data.books).forEach(([keyword, book]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${keyword}</td>
            <td>${book.title}</td>
            <td>${book.author}</td>
          `; 
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      } else {
        document.querySelector("#result").textContent = "関連書籍が見つかりませんでした。";
      }
    });
  </script>
</body>
</html>